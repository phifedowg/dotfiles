# Load antigen if available
if [[ -f "$HOME/.antigen/antigen.zsh" ]]; then
    source "$HOME/.antigen/antigen.zsh"
    antigen use oh-my-zsh
    antigen bundle git
    antigen bundle git-prompt
    antigen bundle heroku
    antigen bundle pip
    antigen bundle lein
    antigen bundle command-not-found
    antigen bundle systemd
    antigen bundle docker
    antigen bundle bundler
    antigen bundle tmux
    antigen bundle vi-mode
    antigen bundle cp
    antigen bundle ssh-agent
    antigen bundle colorize
    antigen bundle encode64
    antigen bundle github
    antigen bundle zsh-users/zsh-syntax-highlighting
    antigen bundle zsh-users/zsh-autosuggestions
    antigen theme steeef
    antigen apply
fi

# Custom history management function
function omz_history {
  zparseopts -E c=clear l=list
  if [[ -n "$clear" ]]; then
    echo -n >| "$HISTFILE"
    echo >&2 History file deleted. Reload the session to see its effects.
  elif [[ -n "$list" ]]; then
    builtin fc "$@"
  else
    builtin fc "$@" -l 1
  fi
}

# Aliases for history with date format stamps
case $HIST_STAMPS in
  "mm/dd/yyyy") alias history='omz_history -f' ;;
  "dd.mm.yyyy") alias history='omz_history -E' ;;
  "yyyy-mm-dd") alias history='omz_history -i' ;;
  "") alias history='omz_history' ;;
  *) alias history="omz_history -t '$HIST_STAMPS'" ;;
esac

# History settings
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
setopt extended_history
setopt hist_expire_dups_first
setopt hist_ignore_dups
setopt hist_ignore_space
setopt hist_verify
setopt inc_append_history
setopt share_history

# Plugins and completions
plugins=(git docker terraform zsh-syntax-highlighting zsh-autosuggestions)
fpath+=("$HOME/.config/hcloud/completion/zsh")
autoload -U +X bashcompinit && bashcompinit
complete -o nospace -C /usr/bin/terraform terraform

# Load additional configurations if available
[ -s "$HOME/.config/envman/load.sh" ] && source "$HOME/.config/envman/load.sh"
source "$HOME/.zsh_aliases"

# Export environment variables (move these to .zshenv for better practice)
export ZSH="$HOME/.antigen/bundles/robbyrussell/oh-my-zsh"
export PATH=/usr/local/bin:$PATH
export HCLOUD_TOKEN=$(cat "$HOME/.hcloud_token") # Use a secure file for the token
export EDITOR=/usr/bin/vim
export BROWSER=/usr/bin/chromium

# Custom functions
mkcd() { mkdir -p "$1" && cd "$1"; }
extract() { tar -xf "$1" && cd "${1%.*}"; }

# Load autojump if available
if [[ -f /usr/share/autojump/autojump.zsh ]]; then
    source /usr/share/autojump/autojump.zsh
fi

# Fuzzy history search with Ctrl-R
bindkey '^R' history-incremental-pattern-search-backward

# Start GPG and SSH agents if they are not running
if ! pgrep -u "$USER" gpg-agent > /dev/null; then
    eval "$(gpg-agent --daemon)"
fi

if ! pgrep -u "$USER" ssh-agent > /dev/null; then
    eval "$(ssh-agent -s)"
fi

# Environment-specific settings
#if [[ $HOST == "work-machine" ]]; then
#    export PATH=$PATH:/work-specific/path
#else
#    export PATH=$PATH:/personal-specific/path
#fi
# Initialize Keychain and add specific SSH keys
eval $(keychain --eval --agents ssh ssh-mg-precipoint.key ssh-phife.key)

